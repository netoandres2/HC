<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historia Cl√≠nica por Voz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --card: #0f172a;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #ef4444;
      --success: #22c55e;
      --radius: 0.9rem;
      --shadow: 0 18px 40px rgba(0,0,0,0.45);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 45%, #020617 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    header h1 span.logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 15px var(--accent);
    }

    header p {
      margin: 0.25rem 0 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    main {
      padding: 1rem;
      display: grid;
      gap: 1rem;
    }

    @media (min-width: 900px) {
      main {
        grid-template-columns: minmax(280px, 360px) minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 1rem;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      color: var(--muted);
      background: rgba(15,23,42,0.9);
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--danger);
    }

    .chip-dot.active {
      background: var(--success);
      box-shadow: 0 0 12px var(--success);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      align-items: center;
    }

    button {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.45rem 0.9rem;
      font-size: 0.9rem;
      cursor: pointer;
      background: #020617;
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease, border-color 0.08s ease;
    }

    button.primary {
      background: var(--accent);
      color: #0b1120;
      font-weight: 500;
      box-shadow: 0 0 20px rgba(56,189,248,0.4);
    }

    button.primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
    }

    button.secondary {
      border-color: var(--border);
      background: rgba(15,23,42,0.9);
    }

    button.section-btn {
      border-radius: 999px;
      padding-inline: 0.8rem;
      font-size: 0.8rem;
      border-color: var(--border);
      background: rgba(15,23,42,0.95);
      color: var(--muted);
    }

    button.section-btn.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: rgba(56,189,248,0.5);
    }

    button:not(:disabled):active {
      transform: scale(0.97);
      box-shadow: none;
    }

    select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.35rem 0.6rem;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .status-text {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }

    .status-text strong {
      color: var(--accent);
    }

    textarea {
      width: 100%;
      min-height: 70px;
      resize: vertical;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      padding: 0.55rem 0.7rem;
      font-size: 0.85rem;
      line-height: 1.4;
      margin-top: 0.35rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .section-grid {
      display: grid;
      gap: 0.8rem;
    }

    @media (min-width: 900px) {
      .section-grid {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }

    .section-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .badge {
      font-size: 0.7rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid var(--border);
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .hint {
      font-size: 0.76rem;
      color: var(--muted);
      margin-top: 0.5rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }

    .danger-text {
      color: var(--danger);
      font-size: 0.8rem;
    }

    .small {
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>
      <span class="logo-dot"></span>
      Historia Cl√≠nica por Voz
    </h1>
    <p>Transcripci√≥n en vivo y organizaci√≥n por secciones: motivo, enfermedad actual, antecedentes y revisi√≥n por sistemas.</p>
  </header>

  <main>
    <!-- PANEL IZQUIERDO: CONTROL DE AUDIO Y TRANSCRIPCI√ìN GENERAL -->
    <section class="card">
      <h2>
        üéôÔ∏è Captura de voz
      </h2>

      <div class="controls-row">
        <button id="startBtn" class="primary">
          ‚ñ∂Ô∏è Empezar dictado
        </button>
        <button id="stopBtn" class="secondary" disabled>
          ‚èπ Detener
        </button>

        <div class="chip" id="micStatusChip">
          <span class="chip-dot" id="micDot"></span>
          <span id="micStatusLabel">Micr√≥fono inactivo</span>
        </div>
      </div>

      <div class="controls-row">
        <label class="small">
          Idioma del reconocimiento:
          <select id="langSelect">
            <option value="es-ES">Espa√±ol (Espa√±a)</option>
            <option value="es-CO">Espa√±ol (Colombia)</option>
            <option value="es-MX">Espa√±ol (M√©xico)</option>
            <option value="en-US">Ingl√©s (US)</option>
          </select>
        </label>
      </div>

      <p class="status-text" id="supportText"></p>

      <div style="margin-top: 0.75rem;">
        <div class="section-label">
          <span>√öltimo fragmento reconocido</span>
          <span class="badge">Solo lectura</span>
        </div>
        <textarea id="lastChunk" readonly placeholder="Aqu√≠ ver√°s el √∫ltimo texto que el sistema haya reconocido..."></textarea>
      </div>

      <div style="margin-top: 0.75rem;">
        <div class="section-label">
          <span>Transcripci√≥n completa (bruta)</span>
          <span class="badge">Editable</span>
        </div>
        <textarea id="rawTranscript" placeholder="Transcripci√≥n completa de toda la conversaci√≥n. Puedes editarla manualmente si lo necesitas."></textarea>
      </div>

      <p class="hint">
        üîê <strong>Privacidad:</strong> este prototipo funciona totalmente en el navegador, sin enviar la historia cl√≠nica a ning√∫n servidor.  
        ‚ö†Ô∏è No lo uses todav√≠a como sistema oficial de historia cl√≠nica; es solo una herramienta de apoyo.
      </p>
    </section>

    <!-- PANEL DERECHO: SECCIONES DE LA HISTORIA CL√çNICA -->
    <section class="card">
      <h2>ü©∫ Secciones de la historia cl√≠nica</h2>

      <p class="status-text">
        Selecciona la <strong>secci√≥n activa</strong>. Todo lo que se dicte se a√±adir√° ah√≠ de forma autom√°tica:
      </p>

      <div class="pill-row">
        <button class="section-btn active" data-section="motivo">Motivo de consulta</button>
        <button class="section-btn" data-section="enfActual">Enfermedad actual</button>
        <button class="section-btn" data-section="antecedentes">Antecedentes</button>
        <button class="section-btn" data-section="revision">Revisi√≥n por sistemas</button>
      </div>

      <p class="hint">
        Consejo de uso: durante la anamnesis puedes ir cambiando de secci√≥n seg√∫n el momento de la entrevista
        (p. ej. motivo de consulta ‚Üí enfermedad actual ‚Üí antecedentes ‚Üí revisi√≥n por sistemas).
      </p>

      <div class="section-grid" style="margin-top: 0.5rem;">
        <div>
          <div class="section-label">
            <span>Motivo de consulta</span>
            <span class="badge mono">MC</span>
          </div>
          <textarea id="motivoField" placeholder="‚ÄúDolor tor√°cico de 2 horas de evoluci√≥n‚Ä¶‚Äù"></textarea>
        </div>

        <div>
          <div class="section-label">
            <span>Enfermedad actual</span>
            <span class="badge mono">EA</span>
          </div>
          <textarea id="enfActualField" placeholder="Descripci√≥n detallada cronol√≥gica del cuadro cl√≠nico‚Ä¶"></textarea>
        </div>

        <div>
          <div class="section-label">
            <span>Antecedentes</span>
            <span class="badge mono">AP / AF / AQ / AM / GO</span>
          </div>
          <textarea id="antecedentesField" placeholder="Antecedentes personales, familiares, quir√∫rgicos, farmacol√≥gicos, t√≥xicos‚Ä¶"></textarea>
        </div>

        <div>
          <div class="section-label">
            <span>Revisi√≥n por sistemas</span>
            <span class="badge mono">RS</span>
          </div>
          <textarea id="revisionField" placeholder="S√≠ntomas dirigidos por aparatos y sistemas‚Ä¶"></textarea>
        </div>
      </div>

      <p class="hint">
        ‚ú® Puedes copiar y pegar estas secciones en tu historia cl√≠nica oficial (HIS, EMR, etc.).
        Si quieres, despu√©s podemos a√±adir un bot√≥n que exporte todo a PDF o a un formato est√°ndar.
      </p>
    </section>
  </main>

  <script>
    (function () {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const micStatusChip = document.getElementById("micStatusChip");
      const micDot = document.getElementById("micDot");
      const micStatusLabel = document.getElementById("micStatusLabel");
      const supportText = document.getElementById("supportText");
      const langSelect = document.getElementById("langSelect");

      const lastChunkEl = document.getElementById("lastChunk");
      const rawTranscriptEl = document.getElementById("rawTranscript");

      const motivoField = document.getElementById("motivoField");
      const enfActualField = document.getElementById("enfActualField");
      const antecedentesField = document.getElementById("antecedentesField");
      const revisionField = document.getElementById("revisionField");

      const sectionButtons = document.querySelectorAll("button.section-btn");

      let recognition = null;
      let listening = false;
      let activeSection = "motivo";

      function updateMicUI() {
        if (!listening) {
          micDot.classList.remove("active");
          micStatusLabel.textContent = "Micr√≥fono inactivo";
          startBtn.disabled = !SpeechRecognition;
          stopBtn.disabled = true;
        } else {
          micDot.classList.add("active");
          micStatusLabel.textContent = "Escuchando‚Ä¶";
          startBtn.disabled = true;
          stopBtn.disabled = false;
        }
      }

      function setActiveSection(section) {
        activeSection = section;
        sectionButtons.forEach((btn) => {
          if (btn.dataset.section === section) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });
      }

      sectionButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          setActiveSection(btn.dataset.section);
        });
      });

      if (!SpeechRecognition) {
        supportText.innerHTML =
          "<span class='danger-text'>Tu navegador no soporta reconocimiento de voz nativo.</span> Prueba con Chrome en escritorio para usar el dictado.";
        startBtn.disabled = true;
      } else {
        supportText.textContent =
          "Pulsa ‚ÄúEmpezar dictado‚Äù y concede permiso al micr√≥fono. Habla con el paciente de forma natural; puedes ir cambiando la secci√≥n activa seg√∫n el momento de la entrevista.";
      }

      function ensureRecognition() {
        if (!SpeechRecognition) return null;
        if (!recognition) {
          recognition = new SpeechRecognition();
          recognition.continuous = true;
          recognition.interimResults = true;
        }
        recognition.lang = langSelect.value || "es-ES";
        return recognition;
      }

      startBtn.addEventListener("click", () => {
        const rec = ensureRecognition();
        if (!rec) return;

        try {
          rec.start();
          listening = true;
          updateMicUI();
        } catch (err) {
          console.error(err);
        }
      });

      stopBtn.addEventListener("click", () => {
        if (!recognition) return;
        recognition.stop();
        listening = false;
        updateMicUI();
      });

      if (SpeechRecognition) {
        ensureRecognition();

        recognition.onstart = () => {
          listening = true;
          updateMicUI();
        };

        recognition.onend = () => {
          listening = false;
          updateMicUI();
        };

        recognition.onerror = (event) => {
          console.error("SpeechRecognition error:", event);
          supportText.innerHTML =
            "<span class='danger-text'>Error en el reconocimiento de voz:</span> " +
            (event.error || "desconocido") +
            ". Si el problema persiste, intenta recargar la p√°gina.";
        };

        recognition.onresult = (event) => {
          let finalChunk = "";
          let interimChunk = "";

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const result = event.results[i];
            const transcript = result[0].transcript;

            if (result.isFinal) {
              finalChunk += transcript + " ";
            } else {
              interimChunk += transcript;
            }
          }

          if (finalChunk) {
            const clean = finalChunk.trim() + " ";

            lastChunkEl.value = clean;
            rawTranscriptEl.value += clean;

            switch (activeSection) {
              case "motivo":
                motivoField.value += clean;
                break;
              case "enfActual":
                enfActualField.value += clean;
                break;
              case "antecedentes":
                antecedentesField.value += clean;
                break;
              case "revision":
                revisionField.value += clean;
                break;
            }
          } else if (interimChunk) {
            lastChunkEl.value = "[Interim] " + interimChunk;
          }
        };
      }

      // Por si el usuario cambia de idioma mientras est√° parado
      langSelect.addEventListener("change", () => {
        if (!SpeechRecognition) return;
        if (!recognition) return;
        recognition.lang = langSelect.value;
      });

      updateMicUI();
    })();
  </script>
</body>
</html>
